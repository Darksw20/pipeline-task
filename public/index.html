<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Comprar Bitcoin</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				background-color: #f0f0f0;
				margin: 0;
				padding: 20px;
				display: flex;
				justify-content: center;
				align-items: center;
				min-height: 100vh;
			}
			.container {
				background-color: white;
				padding: 20px;
				border-radius: 8px;
				box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
				width: 100%;
				max-width: 400px;
			}
			h1,
			h2 {
				text-align: center;
				color: #333;
			}
			.form-group {
				margin-bottom: 15px;
			}
			label {
				display: block;
				margin-bottom: 5px;
				color: #666;
			}
			input,
			select {
				width: 100%;
				padding: 8px;
				border: 1px solid #ddd;
				border-radius: 4px;
				box-sizing: border-box;
			}
			button[type="submit"] {
				width: 100%;
				padding: 10px;
				background-color: #f7931a;
				color: white;
				border: none;
				border-radius: 4px;
				cursor: pointer;
				font-size: 16px;
			}
			button[type="submit"]:hover {
				background-color: #e07d16;
			}
			.modal {
				display: none;
				position: fixed;
				z-index: 1;
				left: 0;
				top: 0;
				width: 100%;
				height: 100%;
				overflow: auto;
				background-color: rgba(0, 0, 0, 0.4);
			}
			.modal-content {
				background-color: #fefefe;
				margin: 15% auto;
				padding: 20px;
				border: 1px solid #888;
				width: 80%;
				max-width: 500px;
				border-radius: 8px;
			}
			.close {
				color: #aaa;
				float: right;
				font-size: 28px;
				font-weight: bold;
				cursor: pointer;
			}
			.close:hover,
			.close:focus {
				color: black;
				text-decoration: none;
				cursor: pointer;
			}
			#authToggle {
				text-align: center;
				margin-top: 10px;
				color: #f7931a;
				cursor: pointer;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1>Comprar Bitcoin</h1>
			<form id="cryptoForm">
				<div class="form-group">
					<label for="amount">Cantidad</label>
					<input
						type="number"
						id="amount"
						name="amount"
						value="200"
						min="0"
						step="0.01"
						required
					/>
				</div>
				<div class="form-group">
					<label for="currency">Moneda</label>
					<select id="currency" name="currency">
						<option value="USD">USD</option>
						<option value="EUR">EUR</option>
						<option value="GBP">GBP</option>
					</select>
				</div>
				<button type="submit">Comprar Bitcoin</button>
			</form>
		</div>

		<div id="authModal" class="modal">
			<div class="modal-content">
				<span class="close">&times;</span>
				<h2 id="authTitle">Iniciar Sesión</h2>
				<form id="authForm">
					<div id="nameField" class="form-group" style="display: none">
						<label for="name">Nombre</label>
						<input type="text" id="name" name="name" />
					</div>
					<div class="form-group">
						<label for="email">Correo Electrónico</label>
						<input type="email" id="email" name="email" required />
					</div>
					<div class="form-group">
						<label for="password">Contraseña</label>
						<input type="password" id="password" name="password" required />
					</div>
					<button type="submit">Iniciar Sesión</button>
				</form>
				<p id="authToggle">¿No tienes una cuenta? Regístrate</p>
			</div>
		</div>

		<script>
			document.addEventListener("DOMContentLoaded", function () {
				const form = document.getElementById("cryptoForm");
				const modal = document.getElementById("authModal");
				const closeBtn = modal.querySelector(".close");
				const authForm = document.getElementById("authForm");
				const authToggle = document.getElementById("authToggle");
				const authTitle = document.getElementById("authTitle");
				const nameField = document.getElementById("nameField");
				let isLogin = true;

				function setCookie(name, value, days) {
					let expires = "";
					if (days) {
						const date = new Date();
						date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
						expires = "; expires=" + date.toUTCString();
					}
					document.cookie = name + "=" + (value || "") + expires + "; path=/";
				}

				function getCookie(name) {
					const nameEQ = name + "=";
					const ca = document.cookie.split(";");
					for (let i = 0; i < ca.length; i++) {
						let c = ca[i];
						while (c.charAt(0) == " ") c = c.substring(1, c.length);
						if (c.indexOf(nameEQ) == 0)
							return c.substring(nameEQ.length, c.length);
					}
					return null;
				}

				let sessionId = getCookie("sessionId");
				if (!sessionId) {
					modal.style.display = "block";
				}

				closeBtn.onclick = function () {
					modal.style.display = "none";
				};

				window.onclick = function (event) {
					if (event.target == modal) {
						modal.style.display = "none";
					}
				};

				authToggle.onclick = function () {
					isLogin = !isLogin;
					if (isLogin) {
						authTitle.textContent = "Iniciar Sesión";
						authForm.querySelector('button[type="submit"]').textContent =
							"Iniciar Sesión";
						authToggle.textContent = "¿No tienes una cuenta? Regístrate";
						nameField.style.display = "none";

						nameField.querySelector("input").removeAttribute("required");
					} else {
						authTitle.textContent = "Registrarse";
						authForm.querySelector('button[type="submit"]').textContent =
							"Registrarse";
						authToggle.textContent = "¿Ya tienes una cuenta? Inicia Sesión";
						nameField.style.display = "block";

						nameField
							.querySelector("input")
							.setAttribute("required", "required");
					}
				};

				authForm.onsubmit = function (e) {
					e.preventDefault();
					const formData = new FormData(authForm);
					const data = Object.fromEntries(formData.entries());
					data.isLogin = isLogin;

					fetch("/api/auth", {
						method: "POST",
						headers: {
							"Content-Type": "application/json",
						},
						body: JSON.stringify(data),
					})
						.then((response) => response.json())
						.then((data) => {
							console.log("Éxito:", data);
							if (data.sessionId) {
								setCookie("sessionId", data.sessionId, 1);
								modal.style.display = "none";
								sessionId = data.sessionId;
							}
						})
						.catch((error) => {
							console.error("Error:", error);
							alert(
								"Hubo un error en la autenticación. Por favor, intente de nuevo."
							);
						});
				};

				form.addEventListener("submit", function (e) {
					e.preventDefault();
					if (!sessionId) {
						modal.style.display = "block";
						return;
					}
					const formData = new FormData(form);
					const data = Object.fromEntries(formData.entries());
					data.crypto = "BTC";

					fetch("/api/buy-bitcoin", {
						method: "POST",
						headers: {
							"Content-Type": "application/json",
							"X-Session-ID": sessionId,
						},
						body: JSON.stringify(data),
					})
						.then((response) => response.json())
						.then((data) => {
							console.log("Éxito:", data);
							alert("Compra de Bitcoin exitosa!");
						})
						.catch((error) => {
							console.error("Error:", error);
							alert(
								"Hubo un error en la transacción. Por favor, intente de nuevo."
							);
						});
				});
			});
		</script>
	</body>
</html>
